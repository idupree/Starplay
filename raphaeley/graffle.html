<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Raphaël · Graffle</title>
        <link rel="stylesheet" href="demo.css" type="text/css" media="screen">
        <link rel="stylesheet" href="demo-print.css" type="text/css" media="print">
        <script src="raphael.js" type="text/javascript" charset="utf-8"></script>
        <script src="underscore-min.js" type="text/javascript" charset="utf-8"></script>
        <script src="backbone-min.js" type="text/javascript" charset="utf-8"></script>
        <script src="coffee-script.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script src="graffle.js" type="text/javascript" charset="utf-8"></script>
        <style type="text/css" media="screen">
            #holder {
                -moz-border-radius: 10px;
                -webkit-border-radius: 10px;
                border: solid 1px #333;
            }
            p {
                text-align: center;
            }
            canvas, #buttons {
                display: inline-block;
                vertical-align: middle;
            }
            #buttons > button {
                display: block;
            }
            p.script, p#compileDebug { white-space: pre; text-align: left; }
            #error { color: red; }
        </style>
    </head>
    <body>
	<canvas id="gameCanvas"></canvas>
	<div id="buttons">
	<button id="restart">Restart without recompiling</button>
	<button id="reload">Restart fully</button>
	<button id="redaemon">Reload daemons</button>
	<button id="pause_resume">Pause/Resume</button>
	</div>
	<p>Stats: Turn <span id="turn"></span>, Turtles <span id="turtles"></span>; <span id="error"></span></p>

<p class="script" contentEditable="true">
tau = global.tau
modulo = global.modulo
#custom-stuff.
#Constants can be slider variables.

initState = ->
	global.turtles = [_.extend(global.newTurtle(), {x:0, y:0,color:'rgb(88,88,88)',heading:0,type:'crazy'})]
	patchcolor = ->
		'rgb(127,'+(Math.floor Math.min 30*@grass, 255)+',127)'
	global.patches = ((_.extend(global.newPatch(), {color:patchcolor, x:x, y:y, grass:0, 'delta:grass':0}) for y in [0...20]) for x in [0...20])
	global.patches.width = global.patches.length
	global.patches.height = global.patches[0].length
	global.patches.each = (callback) ->
		for col, x in @
			for patch, y in col
				callback(patch, x, y)

initDaemons = ->
	global.turtleFn.activateGun = -> @clone type: 'bullet', color: 'red'
	global.turtleFn.speed = -> @forward 1
	global.turtleFn.wobble = ->
		@rotateLeft tau / 16 * (Math.random() - 0.5)
		@forward 0.25
	global.turtleFn.patchHere = -> global.patches[Math.floor(@x)][Math.floor(@y)]
	global.turtleFn.layGrass = ->
		@patchHere().grass += 5

	global.turtleDaemons =
		speed: -> @type == 'bullet'
		activateGun: -> @type == 'crazy' and global.time % 8 == 0
		wobble: -> @type == 'crazy'
		layGrass: -> true

	#global.patchFn.diffuse4 = (chemicalName, rate) ->
	#	amountHere = +@[chemicalName]
	#	spreadAmount = amountHere * rate
	#	eachGets = spreadAmount / 5
	diffuseGrass = ->
		transfer = (patch1, patch2) ->
			patch1.grass / 10 / (4+1)
		global.patches.each (patch1, x, y) ->
			for patch2 in [ global.patches[modulo x+1, global.patches.width ][y] ,
					global.patches[x][modulo y+1, global.patches.height] ]
				deltaHere = transfer(patch2, patch1) - transfer(patch1, patch2)
				patch1['delta:grass'] += deltaHere
				patch2['delta:grass'] -= deltaHere
		global.patches.each (patch, x, y) ->
			patch.grass += patch['delta:grass']
			patch['delta:grass'] = 0

	decayGrass = ->
		global.patches.each (patch, x, y) ->
			patch.grass *= 0.99

	global.globalDaemons =
		diffuseGrass: diffuseGrass
		decayGrass: decayGrass
	#global.patchF

return { initState: initState, initDaemons: initDaemons }

</p>
<hr />
<p id="compileDebug"></p>
<!--        <p>Drag shapes around.</p>
        <div id="holder"></div>
        <p id="copy">Demo of <a href="http://raphaeljs.com/">Raphaël</a>—JavaScript Vector Library</p>-->
    </body>
</html>
